<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Garment Details</title>
  <link rel="stylesheet" href="./Styles/nav.css"/>
  <link rel="stylesheet" href="./Styles/garmentDetails.css" />
</head>
<body>
  <header>
    <nav class="navbar">
      <a href="index.html">Home</a>
      <a href="shop.html">Shop</a>
      <a href="contact.html" class="active">Contact Us</a>
      <a id="loginButton" href="login.html">Log In</a>
    </nav>
    <script src="./javaScript/authCheck.js" defer></script>
  </header>

  <main>
    <div id="garmentContainer" class="detail-container">
      Loading garment…
    </div>
  </main>

  <!-- Sirv viewer -->
  <script src="https://scripts.sirv.com/sirvjs/v3/sirv.js"></script>

  <script>
    (async()=> {
      // Get NFC tag from query string
      const params = new URLSearchParams(location.search);
      const tag = params.get("nfcTagId");
      if (!tag) {
        document.getElementById("garmentContainer").innerText = "No ID provided.";
        return;
      }

      // Fetch garment details
      const res = await fetch(`/.netlify/functions/getGarmentByNfc?nfcTagId=${encodeURIComponent(tag)}`, {
        credentials: "include"
      });
      if (!res.ok) {
        const msg = res.status === 401
          ? "Please log in."
          : res.status === 403
            ? "You don’t own this."
            : "Not found.";
        document.getElementById("garmentContainer").innerText = msg;
        return;
      }
      const g = await res.json();

      // ▷ TEMPORARY FALLBACK for tech-pack assets
      const techImages = g.techPackImages || [
        `/Images/techPack/t-shirt.webp`,
        `/Images/techPack/t-shirt2.webp`
      ];
      const techDownload = g.techPackDownloadUrl || `/TechPacks/Techpack.ai`;

      // Build HTML
      const html = `
        <!-- Tech Pack Slideshow -->
        <div class="slideshow-container">
          ${techImages.map((img,i)=>
            `<img class="slide" src="${img}" alt="Tech Pack ${i+1}">`
          ).join("")}
          <a class="prev" onclick="plusSlides(-1)">❮</a>
          <a class="next" onclick="plusSlides(1)">❯</a>
        </div>

        <!-- Download Tech Pack Button -->
        <a href="${techDownload}" download class="download-button">Download Tech Pack</a>

        <h1>${g.garmentName}</h1>

        <!-- Sirv spin viewer -->
        <div class="Sirv" data-src="${g.spinUrl}"></div>

        <section class="details">
          <h2>Fabric</h2>
          <ul>
            <li><strong>Type:</strong> ${g.fabricType || "—"}</li>
            <li><strong>GSM:</strong> ${g.fabricGSM || "—"}</li>
            <li><strong>Color:</strong> ${g.fabricColorName || g.fabricColorHex || "—"}</li>
            <li><strong>Source:</strong> ${g.fabricSource || "—"}</li>
          </ul>

          <h2>Thread</h2>
          <ul>
            <li><strong>Type:</strong> ${g.threadType || "—"}</li>
            <li><strong>Weight:</strong> ${g.threadWeight || "—"}</li>
            <li><strong>Material:</strong> ${g.threadMaterial || "—"}</li>
            <li><strong>Color:</strong> ${g.threadColorName || g.threadColorHex || "—"}</li>
            <li><strong>Source:</strong> ${g.threadSource || "—"}</li>
          </ul>

          <h2>Purchase Info</h2>
          <ul>
            <li><strong>Purchased by:</strong> ${g.owner}</li>
            <li><strong>Quantity:</strong> ${g.quantity}</li>
            <li><strong>Price:</strong> $${g.price}</li>
            <li><strong>First Opened:</strong> ${new Date(g.createdAt).toLocaleDateString()}</li>
            <li><strong>Last Updated:</strong> ${new Date(g.updatedAt).toLocaleString()}</li>
          </ul>
        </section>
      `;
      document.getElementById("garmentContainer").innerHTML = html;
      showSlides(1);
    })();

    // Simple slideshow controls
    let slideIndex = 1;
    function plusSlides(n) {
      showSlides(slideIndex += n);
    }
    function showSlides(n) {
      const slides = document.getElementsByClassName("slide");
      if (!slides.length) return;
      if (n > slides.length) slideIndex = 1;
      if (n < 1) slideIndex = slides.length;
      for (let s of slides) s.style.display = "none";
      slides[slideIndex-1].style.display = "block";
    }
    document.addEventListener("DOMContentLoaded", () => showSlides(slideIndex));
  </script>
</body>
</html>
